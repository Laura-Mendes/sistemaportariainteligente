{% extends "base.html" %}
{% block title %}{{ "Novo Morador" if not morador else "Editar Morador" }}{% endblock %}
{% block content %}

<!-- Moradores -->
<nav class="navbar" style="padding: 10px 24px;">
  <a class="navbar-brand">
    <div class="navbar-brand fw-bold mt-2" style="font-size: 35px; color: rgb(27, 27, 27);">Sistema de Cadastro</div>
  </a>
</nav>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} text-center w-50 mx-auto mt-3" style="background-color: #DBEAFF; color: #2f60e6; border: 1px solid #2f60e6;">
        <p style="margin: 0;">{{ message }}</p>
        <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<main class="container px-4 fade-in"> <!-- container-fluid do Bootstrap faz o formulário sempre ocupar 100% da largura da tela, mas só o container não -->
  
  <br>

  <div class="form-wrapper row gx-1 gy-2 p-3 mt-2 rounded bg-white" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2)">
    <!-- Cabeçalho -->
    <div class="d-flex align-items-center align-items-start w-100">
      <img src="{{ url_for('static', filename='imagens/img-icon/1.png') }}" style="width: 80px; border-radius: 70px;">
        <div class="mt-3">
          <h2 class="fs-4 fw-semibold mb-0" style="color: #292929;">
            {{ "Atualizar Morador" if morador else "Cadastrar Novo Morador" }}
          </h2>

          <p style="color: #6666669c;">
            {{ "Edite os dados do morador abaixo." if morador else "Registre um novo morador no condomínio." }}
          </p>
        </div>
    </div>

    <!-- Formulário -->
     <form method="POST" enctype="multipart/form-data" 
      action="{{ url_for('moradores_bp.salvar' if not morador else 'moradores_bp.atualizar') }}">
      {% if morador %}
        <input type="hidden" name="id" value="{{ morador.id }}">
      {% endif %}

      <h4 class="fs-6 fw-semibold mb-0 mt-4 mb-4" style="color: #292929;">Dados Pessoais</h4>
      <hr style="color: #838282e8;">
      <div class="row">
  
        <div class="col-12 mt-2">
          <div>
            <label for="nome_morador" class="form-label">Nome Completo</label>
            <input style="border-color: #83828238;" type="text" name="nome_morador" id="nome_morador" placeholder="Ex: Larissa da Silva Santos" value="{{ morador.nome_morador if morador else '' }}" class="form-control" required>
          </div>
        </div>

        <div class="col-md-6 d-flex flex-column gap-2 mt-2">
          <div>
            <label for="email_morador" class="form-label">E-mail</label>
            <input style="border-color: #83828238;" type="email" name="email_morador" id="email_morador" placeholder="Ex: exemplo@gmail.com" value="{{ morador.email_morador if morador else '' }}" class="form-control" required>
          </div>
          <div>
            <label for="cpf_morador" class="form-label">CPF</label>
            <input style="border-color: #83828238;" type="text" name="cpf_morador" id="cpf_morador" placeholder="Ex: 000.000.000-00" value="{{ morador.cpf_morador if morador else '' }}" class="form-control" required>
          </div>
        </div>

        <div class="col-md-6 d-flex flex-column gap-2 mt-2">
          <div>
            <label for="telefone_morador" class="form-label">Telefone</label>
            <input style="border-color: #83828238;" type="tel" name="telefone_morador" id="telefone_morador" placeholder="Ex: (99) 99999-9999" value="{{ morador.telefone_morador if morador else '' }}" class="form-control" required>
          </div>
          <div>
            <label for="nascimento_morador" class="form-label">Data de Nascimento</label>
            <input style="border-color: #83828238;" type="date" name="nascimento_morador" id="nascimento_morador" value="{{ morador.nascimento_morador if morador else '' }}" class="form-control" required>
          </div>
        </div>

      <h4 class="fs-6 fw-semibold mb-0 mt-4 mb-4" style="color: #292929;">Dados Residenciais</h4>
      <hr style="color: #838282e8;">

      <div class="row">

        <div class="col-md-6 d-flex flex-column gap-2 mt-2">
          <div>
            <label for="apartamento_morador" class="form-label">Apartamento</label>
            <input style="border-color: #83828238;" type="text" name="apartamento_morador" id="apartamento_morador" placeholder="Ex: 101" value="{{ morador.apartamento_morador if morador else '' }}" class="form-control" required>
          </div>
            <div>
              <label for="moradia_morador" class="form-label">Tipo de Moradia</label>
              <select style="border-color: #83828238;" name="moradia_morador" class="form-control" required>
                <option value="inquilino">Inquilino</option>
                <option value="proprietario">Proprietário</option>
              </select>
            </div>
        </div>

        <div class="col-md-6 d-flex flex-column gap-2 mt-2">
          <div>
            <label for="bloco_morador" class="form-label">Bloco</label>
            <input style="border-color: #83828238;" type="text" name="bloco_morador" id="bloco_morador" placeholder="Ex: A" value="{{ morador.bloco_morador if morador else '' }}" class="form-control" required>
          </div>
          <div>
              <label for="quantidade_morador" class="form-label">Quantidade moradores</label>
              <select style="border-color: #83828238;" name="quantidade_morador" class="form-control" required>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </div>
        </div>

      </div>

      <h4 class="fs-6 fw-semibold mb-0 mt-4 mb-4" style="color: #292929;">Veículo (Opcional)</h4>
      <hr style="color: #838282e8;">
      <div class="row">
        <div class="col-md-4 d-flex flex-column gap-2">
          <label for="placa" class="form-label">Placa</label>
          <input type="text" class="form-control" name="placa" id="placa"
                placeholder="Ex: ABC-1234"
                value="{{ morador.veiculos[0].placa if morador and morador.veiculos else '' }}">
        </div>
        <div class="col-md-4 d-flex flex-column gap-2">
          <label for="modelo" class="form-label">Modelo</label>
          <input type="text" class="form-control" name="modelo" id="modelo"
                value="{{ morador.veiculos[0].modelo if morador and morador.veiculos else '' }}">
        </div>
        <div class="col-md-4 d-flex flex-column gap-2">
          <label for="cor" class="form-label">Cor</label>
          <input type="text" class="form-control" name="cor" id="cor"
                value="{{ morador.veiculos[0].cor if morador and morador.veiculos else '' }}">
        </div>
      </div>

      <h4 class="fs-6 fw-semibold mb-0 mt-4 mb-4" style="color: #292929;">Foto do Morador</h4>
      <hr style="color: #838282e8;">
      
      <div class="row d-flex justify-content-center">
          <div class="col-md-6 d-flex flex-column gap-2">
          <label class="form-label">Tirar Foto com a Câmera</label>
            <!-- Vídeo da câmera -->
            <video id="video" autoplay style="width:100%; border:1px solid #ccc; border-radius:8px;"></video>
            <!-- Botão para capturar -->
            <button type="button" id="captureBtn" class="btn btn-outline-purple mt-2">Tirar Foto</button>
            <!-- Canvas escondido -->
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <!-- Campo hidden para enviar a imagem -->
            <input type="hidden" name="foto_morador_data" id="foto_morador_data">
            <input type="hidden" name="face_descriptor" id="face_descriptor">
            <!-- Preview da foto tirada -->
            <img id="preview" style="max-width:150px; border-radius:8px; display:none; margin-top:10px;">
          {% if morador and morador.foto_morador %}
            <p class="mt-2">Foto atual:</p>
            <img src="{{ url_for('static', filename='uploads/' ~ morador.foto_morador) }}" 
                style="max-width:150px; border-radius:8px;">
          {% endif %}
        </div>
      </div>

      <!-- Botões -->
      <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-dark">
          <i class="bi bi-save me-2"></i>
          {{ "Atualizar Morador" if morador else "Cadastrar Morador" }}
        </button>

          {% if not morador %}
            <button type="reset" class="btn btn-light" style="border-color: #83828238;">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </button>
          {% endif %}
        </div>

  <a href="{{ url_for('moradores_bp.listar_moradores') }}" class="btn btn-light" style="border-color: #83828238;">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>
</form>
</div>
</main>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Depois o plugin de máscara -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
  $(document).ready(function(){
    // CPF -> 000.000.000-00
    $('#cpf_morador').mask('000.000.000-00');
    
    // Telefone -> (99) 99999-9999
    $('#telefone_morador').mask('(00) 00000-0000');
    
  });
</script>

<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script defer src="{{ url_for('static', filename='js/face.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
  @media (max-width: 768px) {
  /* Faz "Sistema de Cadastro" quebrar linha quando necessário */
  .navbar .navbar-brand .fw-bold {
    white-space: normal !important;
    font-size: 26px !important;  /* reduz levemente para caber */
    line-height: 1.2;
    display: block;
  }
}
</style>

{% endblock %}